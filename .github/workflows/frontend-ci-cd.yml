name: Frontend CI-CD

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

env:
  IMAGE_NAME: frontend-users
  CHART_PATH: helm/frontend-users
  RELEASE_NAME: frontend-users

jobs:
  build-test-deploy:
    runs-on: ubuntu-latest
    env:
      REGISTRY_HOST: ${{ secrets.REGISTRY_HOST }}
      REGISTRY_NAMESPACE: ${{ secrets.REGISTRY_NAMESPACE }}
      BUILD_NUMBER: ${{ github.run_number }}
      OPENSHIFT_NAMESPACE: ${{ secrets.OPENSHIFT_NAMESPACE }}
      OPENSHIFT_SKIP_TLS_VERIFY: ${{ secrets.OPENSHIFT_SKIP_TLS_VERIFY }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Run build
        env:
          VITE_API_BASE_URL: ${{ secrets.FRONTEND_PUBLIC_API_BASE_URL }}
        run: npm run build

      - name: Compute image reference
        run: |
          if [ -z "${REGISTRY_HOST}" ] || [ -z "${REGISTRY_NAMESPACE}" ]; then
            echo "REGISTRY_HOST and REGISTRY_NAMESPACE secrets must be provided" >&2
            exit 1
          fi
          IMAGE_REPOSITORY="${REGISTRY_HOST}/${REGISTRY_NAMESPACE}/${IMAGE_NAME}"
          IMAGE_TAG="${GITHUB_SHA::7}-${BUILD_NUMBER}"
          echo "IMAGE_REPOSITORY=${IMAGE_REPOSITORY}" >> "$GITHUB_ENV"
          echo "IMAGE_TAG=${IMAGE_TAG}" >> "$GITHUB_ENV"
          echo "IMAGE_URI=${IMAGE_REPOSITORY}:${IMAGE_TAG}" >> "$GITHUB_ENV"

      - name: Log in to container registry
        run: |
          echo "${{ secrets.REGISTRY_PASSWORD }}" | docker login "${REGISTRY_HOST}" -u "${{ secrets.REGISTRY_USERNAME }}" --password-stdin

      - name: Build container image
        run: docker build -t "${IMAGE_URI}" .

      - name: Push container image
        run: docker push "${IMAGE_URI}"

      - name: Set up Helm
        uses: azure/setup-helm@v4

      - name: Lint Helm chart
        run: helm lint "${CHART_PATH}"

      - name: Package Helm chart
        run: helm package "${CHART_PATH}" --destination packaged-chart

      - name: Install oc CLI
        uses: redhat-actions/oc-installer@v1
        with:
          version: 4.15.0

      - name: Login to OpenShift
        env:
          OPENSHIFT_SERVER: ${{ secrets.OPENSHIFT_SERVER }}
          OPENSHIFT_TOKEN: ${{ secrets.OPENSHIFT_TOKEN }}
        run: |
          if [ -z "${OPENSHIFT_SERVER}" ] || [ -z "${OPENSHIFT_TOKEN}" ] || [ -z "${OPENSHIFT_NAMESPACE}" ]; then
            echo "OpenShift secrets OPENSHIFT_SERVER, OPENSHIFT_TOKEN, and OPENSHIFT_NAMESPACE must be provided" >&2
            exit 1
          fi
          if [ "${OPENSHIFT_SKIP_TLS_VERIFY:-true}" = "true" ]; then
            oc login "${OPENSHIFT_SERVER}" --token="${OPENSHIFT_TOKEN}" --insecure-skip-tls-verify
          else
            oc login "${OPENSHIFT_SERVER}" --token="${OPENSHIFT_TOKEN}"
          fi
          oc project "${OPENSHIFT_NAMESPACE}"

      - name: Deploy Helm release
        env:
          FRONTEND_API_BASE_URL: ${{ secrets.FRONTEND_API_BASE_URL }}
          FRONTEND_PUBLIC_API_BASE_URL: ${{ secrets.FRONTEND_PUBLIC_API_BASE_URL }}
        run: |
          if [ -z "${FRONTEND_API_BASE_URL}" ]; then
            echo "Secret FRONTEND_API_BASE_URL must be provided" >&2
            exit 1
          fi
          HELM_ARGS=()
          if [ -n "${FRONTEND_PUBLIC_API_BASE_URL}" ]; then
            HELM_ARGS+=(--set-string "config.apiBaseUrl=${FRONTEND_PUBLIC_API_BASE_URL}")
          fi

          HELM_CMD=(helm upgrade --install "${RELEASE_NAME}" "${CHART_PATH}"
            --namespace "${OPENSHIFT_NAMESPACE}"
            --set "image.repository=${IMAGE_REPOSITORY}"
            --set "image.tag=${IMAGE_TAG}"
            --set "config.proxyTargetUrl=${FRONTEND_API_BASE_URL}")

          if [ "${#HELM_ARGS[@]}" -gt 0 ]; then
            HELM_CMD+=("${HELM_ARGS[@]}")
          fi

          "${HELM_CMD[@]}"
